<div *ngIf="loading" class="loading-container">
  <div class="spinner-border" role="status">
    <span class="visually-hidden">Loading...</span>
  </div>
</div>

<div *ngIf="!loading && player" class="container mt-4">
  <!-- Player Header -->
  <div class="player-header">
    <div class="row align-items-center">
      <div class="col-md-2 text-center">
        <div class="player-avatar">
          {{ player.firstName?.charAt(0) }}{{ player.lastName?.charAt(0) }}
        </div>
      </div>
      <div class="col-md-7">
        <h1 class="player-name">{{ player.firstName }} {{ player.lastName }}</h1>
        <div class="player-position">
          {{ player.position }} • {{ player.archetype }} • #{{ player.jerseyNumber }}
        </div>
        <div class="team-badge" *ngIf="teamName">
          {{ teamName }}
        </div>
      </div>
      <div class="col-md-3">
        <div class="stat-grid">
          <div class="stat-item">
            <div class="stat-label">Age</div>
            <div class="stat-value">{{ player.age }}</div>
          </div>
          <div class="stat-item">
            <div class="stat-label">Height</div>
            <div class="stat-value">{{ player.height }}"</div>
          </div>
          <div class="stat-item">
            <div class="stat-label">Weight</div>
            <div class="stat-value">{{ player.weight }} lbs</div>
          </div>
          <div class="stat-item">
            <div class="stat-label">Hand</div>
            <div class="stat-value">{{ player.handedness }}</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <!-- Player Details -->
    <div class="col-lg-4">
      <div class="stat-card">
        <h5 class="mb-3">
          <i class="fas fa-user me-2"></i>Player Details
        </h5>
        <div class="row">
          <div class="col-6 mb-3">
            <div class="stat-label">Call Name</div>
            <div class="stat-value">{{ player.callName || 'N/A' }}</div>
          </div>
          <div class="col-6 mb-3">
            <div class="stat-label">Origin</div>
            <div class="stat-value">{{ player.origin || 'N/A' }}</div>
          </div>
          <div class="col-6 mb-3">
            <div class="stat-label">Fighting</div>
            <div class="stat-value">{{ player.fightTendency || 'N/A' }}</div>
          </div>
          <div class="col-6 mb-3">
            <div class="stat-label">Race</div>
            <div class="stat-value">{{ player.race || 'N/A' }}</div>
          </div>
          <div class="col-6 mb-3">
            <div class="stat-label">Hair</div>
            <div class="stat-value">{{ player.hair || 'N/A' }}</div>
          </div>
          <div class="col-6 mb-3">
            <div class="stat-label">Beard</div>
            <div class="stat-value">{{ player.beard || 'N/A' }}</div>
          </div>
          <div class="col-6 mb-3">
            <div class="stat-label">Stick Tape</div>
            <div class="stat-value">{{ player.stickTapeColor || 'N/A' }}</div>
          </div>
          <div class="col-6 mb-3">
            <div class="stat-label">Twitch</div>
            <div class="stat-value">{{ player.twitch || 'N/A' }}</div>
          </div>
          <div class="col-12 mb-3">
            <div class="stat-label">Referral</div>
            <div class="stat-value">{{ player.referralSource || 'N/A' }}</div>
          </div>
          <div class="col-12">
            <div class="stat-label">Invited By</div>
            <div class="stat-value">{{ player.invitedBy || 'N/A' }}</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Training Section -->
    <div class="col-lg-8">
      <div class="training-section">
        <h5 class="training-title">
          <div class="training-icon">
            <i class="fas fa-dumbbell"></i>
          </div>
          Weekly Training Program
        </h5>

        <!-- Training Submitted State -->
        <div *ngIf="trainingSubmitted" class="training-submitted">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h6 class="mb-1 text-success">✅ Training Submitted</h6>
              <p class="mb-1"><strong>Program:</strong> {{ trainingType }}</p>
              <p class="mb-0">
                <strong>Status:</strong> 
                <span class="badge" 
                      [class.bg-warning]="trainingStatus === 'pending'"
                      [class.bg-success]="trainingStatus === 'processed'">
                  {{ trainingStatus | titlecase }}
                </span>
              </p>
            </div>
            <button class="btn btn-warning" (click)="trainingSubmitted = false">
              <i class="fas fa-edit me-1"></i> Edit Training
            </button>
          </div>
        </div>

        <!-- Training Selection Form -->
        <div *ngIf="!trainingSubmitted" class="training-form">
          <label for="trainingSelect" class="form-label fw-bold">Select Training Program</label>
          <select class="form-select mb-3" 
                  [(ngModel)]="tempTrainingType" 
                  name="training" 
                  (change)="onTrainingChange()"
                  id="trainingSelect">
            <option value="">-- Choose Your Training --</option>
            <option *ngFor="let option of trainingOptions" [value]="option">
              {{ option }}
            </option>
          </select>
          
          <button class="btn btn-primary" 
                  (click)="submitTraining()"
                  [disabled]="!tempTrainingType">
            <i class="fas fa-paper-plane me-1"></i> Submit Training
          </button>
        </div>

        <!-- Secondary Position Progress -->
        <div *ngIf="trainingType === 'Learn Secondary Position'" class="progress-indicator">
          <i class="fas fa-chart-line me-2"></i>
          Secondary Position Progress: {{ secondaryProgress }}/3 weeks completed
        </div>
      </div>
    </div>
  </div>

  <!-- Player Attributes Section -->
  <div class="attributes-section">
    <h5 class="attributes-title">
      <div class="attributes-icon">
        <i class="fas fa-chart-bar"></i>
      </div>
      Player Attributes
    </h5>
    
    <!-- Skater Attributes -->
    <div *ngIf="player.position !== 'G'" class="table-responsive">
      <table class="table table-bordered attributes-table">
        <thead>
          <tr>
            <th *ngFor="let attr of skaterAttributeOrder">{{ attr }}</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td *ngFor="let attr of skaterAttributeOrder" 
                [ngClass]="{ 'table-success': isAttributeAffected(attr) }">
              <div class="attribute-cell">
                <span class="attribute-value">{{ playerAttributes[attr] || 0 }}</span>
                <span *ngIf="isAttributeAffected(attr)" class="training-impact">
                  +{{ getAttributeDelta() }}
                </span>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Goalie Attributes -->
    <div *ngIf="player.position === 'G'" class="table-responsive">
      <table class="table table-bordered attributes-table">
        <thead>
          <tr>
            <th *ngFor="let attr of goalieAttributeOrder">{{ attr }}</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td *ngFor="let attr of goalieAttributeOrder"
                [ngClass]="{ 'table-success': isAttributeAffected(attr) }">
              <div class="attribute-cell">
                <span class="attribute-value">{{ playerAttributes[attr] || 0 }}</span>
                <span *ngIf="isAttributeAffected(attr)" class="training-impact">
                  +{{ getAttributeDelta() }}
                </span>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Training Impact Legend -->
    <div *ngIf="tempTrainingType" class="training-legend">
      <span class="legend-badge">Enhanced</span>
      <small>
        <strong>{{ tempTrainingType }}</strong> will improve the highlighted attributes by 
        <strong>{{ getAttributeDelta() > 0 ? '+' : '' }}{{ getAttributeDelta() }} points</strong>
      </small>
    </div>
  </div>
</div>